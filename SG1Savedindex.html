<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Service Guarantee Chatbot</title>
<style>
  body {
    font-family: Dengxian, Arial, sans-serif;
    margin: 0;
    display: flex;
    height: 100vh;
    background: #f5f7fa;
  }

  .instructions {
    flex: 1;
    padding: 20px;
    background: #fff;
    overflow-y: auto;
    border-left: 2px solid #ccc;
  }

  .instructions h2 {
    margin-top: 0;
  }

  .bot-capabilities {
    background: #e0f0ff;
    border: 1px solid #99ccff;
    padding: 10px;
    margin-bottom: 15px;
  }

  .kh-links {
    background: #fff3cd;
    border-left: 4px solid #ffeeba;
    padding: 10px;
    margin-bottom: 15px;
    font-size: 0.9em;
  }

  .chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #e9eff5;
    padding: 10px;
    border-right: 2px solid #ccc;
  }

  .chat-box {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
  }

  .chat-input {
    display: flex;
    padding: 10px;
    background: #fff;
    border-top: 1px solid #ccc;
  }

  .chat-input input {
    flex: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-family: Dengxian, Arial, sans-serif;
  }

  .bubble {
    max-width: 70%;
    padding: 10px;
    margin: 10px 0;
    border-radius: 15px;
    line-height: 1.6;
    word-break: break-word;
    font-family: Dengxian, Arial, sans-serif;
    white-space: pre-wrap;
  }

  .bot {
    background: #007bff;
    color: white;
    align-self: flex-start;
  }

  .user {
    background: #ddd;
    align-self: flex-end;
  }

  .button-bubble {
    display: inline-block;
    margin: 5px 5px 0 0;
    padding: 8px 12px;
    background: #00aaff;
    color: white;
    border-radius: 12px;
    cursor: pointer;
    font-family: Dengxian, Arial, sans-serif;
  }

  .script-block {
    background: #fff3cd;
    border-left: 4px solid #ffeeba;
    padding: 10px;
    margin: 10px 0;
    white-space: pre-wrap;
  }

  .loading-dots {
    display: inline-block;
  }

  .dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    margin: 0 2px;
    background-color: white;
    border-radius: 50%;
    animation: bounce 1s infinite;
  }

  .dot:nth-child(2){ animation-delay: 0.2s; }
  .dot:nth-child(3){ animation-delay: 0.4s; }

  @keyframes bounce {
    0%, 80%, 100% { transform: scale(0); }
    40% { transform: scale(1); }
  }

  .form-input {
    display: flex;
    flex-direction: column;
    margin: 10px 0;
  }

  .form-input label {
    margin: 5px 0 2px 0;
  }

  .form-input input {
    padding: 5px;
    font-family: Dengxian, Arial, sans-serif;
  }
</style>
</head>
<body>

<div class="chat-container">
  <div id="chat-box" class="chat-box"></div>
  <div class="chat-input">
    <input id="user-input" type="text" placeholder="Type your message..." />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<div class="instructions">
  <h2>Service Guarantee Chatbot Instructions</h2>

  <div class="bot-capabilities">
    <strong>Bot Capabilities:</strong>
    <ul>
      <li>Judge Flight-Hotel Guarantee eligibility</li>
      <li>Guide Special Circumstance cancellation workflow</li>
      <li>Remind agents about missing proofs</li>
      <li>Provide QA-approved script templates</li>
      <li>Provide Knowledge Hub links</li>
      <li>Re-type cancel to <strong>restart</strong> the workflow</li>
    </ul>
  </div>

  <div class="kh-links">
    <strong>KH Links:</strong>
    <ul>
      <li><a href="http://knowledgehub.basebiz.ctripcorp.com/webapp/sp/servicebible/knowledgesync/selectNew?currentBusinessTypeId=26&businessId=6938&subjectId=67740&sceneId=2523886%2C2523914%2C2523942&locale=en-US" target="_blank">Flight-Hotel Cancellation Guarantee</a></li>
      <li><a href="http://knowledgehub.basebiz.ctripcorp.com/webapp/sp/servicebible/knowledgesync/selectNew?currentBusinessTypeId=26&businessId=6938&subjectId=67740&sceneId=2523886%2C2523914%2C2523977&locale=en-US" target="_blank">Special Circumstance Cancellation Service Guarantee</a></li>
    </ul>
    <br>
    <strong>Accepted keywords for proof (for input):</strong>
    <ul>
      <li>Official diagnostics</li>
      <li>Medical leave certificate</li>
      <li>Proof of medical charge</li>
      <li>Proof of relationship</li>
    </ul>
  </div>
</div>

<script>
const chatBox = document.getElementById("chat-box");
const userInput = document.getElementById("user-input");

let currentStep = null;
let currentScenario = null;
let providedProofs = [];
let specialType = null;

const scripts = {
  1: `Greetings from Trip.com!

I'm so sorry to hear that you/your xxx is not able to travel due to xx(covid,surgery...). We understand that this is out of your control, and we'd love to help reduce your loss as much as possible.

Unfortunately, as we negotiated with our hotel partner, we were unable to secure free cancellation.

Now we'd like to seek another option which may help with the free cancellation process. Please provide the following medical documentation:

‚Ä¢ Official Diagnostics  (Well Received)
‚Ä¢ Medical Leave Certificate (Still Needed)
‚Ä¢ Proof of Medical Charge (Still Needed, depending on situation)

Thank you so much for your support!`,

  2: `Dear [Guest's Name],

We were saddened to learn about your medical situation. Regarding your booking, we have made every effort to liaise with the hotel. Unfortunately, due to the non-refundable policy, they could not agree to free cancellation.

However, there is still a possibility. Please provide:

‚Ä¢ Official Diagnostics (Received)
‚Ä¢ Medical Leave Certificate (Received)
‚Ä¢ Proof of Medical Charge (Still Needed, or advise if covered by insurance)

Once provided, we will pursue the cancellation request further. Thank you for your cooperation.`,

  3: `Dear [Guest's Name],

We are sorry to inform you that despite our best efforts, the hotel did not agree to free cancellation due to their strict non-refundable policy.

We understand you need to cancel due to health reasons and we wish you a speedy recovery. To proceed, please provide the following supporting documents:

‚Ä¢ Official Diagnostics (Not Received)
‚Ä¢ Medical Leave Certificate (Not Received)
‚Ä¢ Proof of Medical Charge (Not Received)

Thank you for your understanding.`,

  4: `Dear [Guest's Name],

I am very sorry to inform you that I have tried my best to coordinate with the supplier and explained your situation to the hotel staff. Still, they couldn't agree to modify or cancel this booking for free because the original policy of the booking is non-refundable and non-changeable. 

We are really sorry to hear about what happened (state what specifically happened). I hope she/he recovers quickly. I see that you‚Äôve already shared a medical certificate and proof of charges. Thank you for providing those. However, we might ask for additional documents:

‚Ä¢ Doctor‚Äôs note confirming that your wife/husband/child/parent is unfit to travel.
‚Ä¢ Proof of relationship (e.g., marriage or birth certificate).

These documents are necessary for us to validate the request and ensure further assistance.`
};

// Triple-dot typing
function showLoading(callback){
  const loadingDiv = document.createElement("div");
  loadingDiv.className="bubble bot";
  loadingDiv.innerHTML='<span class="loading-dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>';
  chatBox.appendChild(loadingDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
  setTimeout(()=>{
    chatBox.removeChild(loadingDiv);
    callback();
  },800);
}

function addMessage(text,sender="bot"){
  const bubble = document.createElement("div");
  bubble.className=`bubble ${sender}`;
  bubble.textContent=text;
  chatBox.appendChild(bubble);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function showButtons(options,callback){
  const bubble = document.createElement("div");
  bubble.className="bubble bot";
  options.forEach((opt,i)=>{
    const btn = document.createElement("div");
    btn.className="button-bubble";
    btn.textContent=opt;
    btn.onclick = ()=>{addMessage(opt,"user"); callback(i+1);}
    bubble.appendChild(btn);
  });
  chatBox.appendChild(bubble);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function handleOption(opt){
  if(currentStep==="selectScenario"){
    currentScenario=opt;
    if(opt===1){
      currentStep="fhDates";
      showLoading(()=>{
        addMessage("Flight-Hotel Guarantee selected. Please fill out the dates:");
        addFhForm();
      });
    } else if(opt===2){
      currentStep="specialType";
      showLoading(()=>{
        addMessage("Select Special Circumstance type:");
        showButtons(["Not suitable for travel","Be hospitalized","Fracture","Pregnancy","Mental health","Death"],handleSpecialType);
      });
    }
  } else if(currentStep==="scriptSelection"){
    insertScript(opt);
  }
}

function handleSpecialType(opt){
  const types=["Not suitable for travel","Be hospitalized","Fracture","Pregnancy","Mental health","Death"];
  specialType = types[opt-1];
  showLoading(()=>{
    if(specialType==="Mental health"){
      addMessage("‚ö†Ô∏è For Mental health cases: No proof is needed. Please escalate to CS.");
      currentStep="completed";
    } else if(specialType==="Death"){
      addMessage("‚ö∞Ô∏è For Death cases: No proof is needed. Please remark 'canceled due to death' and indicate the relationship between the deceased person and the guest.");
      currentStep="completed";
    } else {
      addMessage(`Special Circumstance selected: ${specialType}`);
      currentStep="specialProofs";
      addMessage("Enter proofs currently provided (comma separated):");
    }
  });
}

function insertScript(num){
  if(scripts[num]){
    const block = document.createElement("div");
    block.className="script-block";
    block.textContent=`Script selected ‚Üí\n\n${scripts[num]}`;
    chatBox.appendChild(block);
    chatBox.scrollTop = chatBox.scrollHeight;
  }
}

// Flight-Hotel form
function addFhForm(){
  const formDiv = document.createElement("div");
  formDiv.className="form-input";
  formDiv.innerHTML=`
    <label>Affected flight date:</label>
    <input id="fh-flight" type="date" />
    <label>Hotel check-in date:</label>
    <input id="fh-checkin" type="date" />
    <button id="fh-submit">Submit</button>
  `;
  chatBox.appendChild(formDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
  document.getElementById("fh-submit").onclick=()=>{
    const flightDate = new Date(document.getElementById("fh-flight").value);
    const hotelDate = new Date(document.getElementById("fh-checkin").value);
    const eligible = flightDate <= hotelDate;
    showLoading(()=>{
      addMessage(eligible ? "‚úÖ Flight-Hotel Guarantee eligible based on dates" : "‚ùå Not eligible (hotel check-in not affected)");
      currentStep="completed";
    });
  };
}

function processMessage(msg){
  if(msg.toLowerCase()==="cancel"){
    currentStep="selectScenario";
    showLoading(()=>{
      addMessage("üëã Welcome! Select a workflow:");
      showButtons(["Flight-Hotel Guarantee","Special Circumstance"],handleOption);
    });
    return;
  }

  if(currentStep==="specialProofs"){
    providedProofs = msg.split(",").map(s=>s.trim().toLowerCase());
    const allProofs = ["official diagnostics","medical leave certificate","proof of medical charge","proof of relationship"];
    const missing = allProofs.filter(p=>!providedProofs.includes(p));

    showLoading(()=>{
      if(missing.includes("medical leave certificate")){
        insertScript(1);
      } else if(missing.includes("proof of medical charge") && missing.length===1){
        insertScript(2);
      } else if(missing.length===allProofs.length){
        insertScript(3);
      } else if(providedProofs.includes("official diagnostics") && providedProofs.includes("proof of medical charge") && !providedProofs.includes("proof of relationship")){
        insertScript(4);
      } else {
        addMessage(missing.length>0 ? `Missing proofs: ${missing.join(", ")}` : "All proofs provided.");
      }
    });
  }
}

userInput.addEventListener("keydown",function(e){
  if(e.key==="Enter") sendMessage();
});

function sendMessage(){
  const text = userInput.value.trim();
  if(!text) return;
  addMessage(text,"user");
  userInput.value="";
  processMessage(text);
}

// Initial welcome
addMessage("üëã Welcome! Type 'Cancel' to begin a Service Guarantee workflow.","bot");
</script>

</body>
</html>