<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Service Guarantee Chatbot</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      display: flex;
      height: 100vh;
      background: #f5f7fa;
    }
    .instructions {
      flex: 1;
      padding: 20px;
      background: #fff;
      overflow-y: auto;
    }
    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #e9eff5;
      border-left: 2px solid #ccc;
    }
    .chat-box {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
    }
    .chat-input {
      display: flex;
      padding: 10px;
      background: #fff;
      border-top: 1px solid #ccc;
    }
    .chat-input input {
      flex: 1;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .chat-input button {
      margin-left: 10px;
      padding: 10px 20px;
      border: none;
      background: #007bff;
      color: #fff;
      border-radius: 5px;
      cursor: pointer;
    }
    .bubble {
      max-width: 70%;
      padding: 10px;
      margin: 5px 0;
      border-radius: 15px;
      line-height: 1.4;
    }
    .bot {
      background: #007bff;
      color: white;
      align-self: flex-start;
    }
    .user {
      background: #ddd;
      align-self: flex-end;
    }
  </style>
</head>
<body>
  <div class="instructions">
    <h2>Welcome to Service Guarantee Chatbot</h2>
    <p>This chatbot helps test Service Guarantee scenarios. Please note:</p>
    <ol>
      <li>It can only handle simple tasks.</li>
      <li>It cannot read proof documents yet.</li>
      <li>It validates if Flight booking dates affect hotel check-in under F-H Guarantee rules.</li>
      <li>It guides you on missing/insufficient proofs and reminds you to use KA/QC scripts.</li>
      <li>This is a beta version for testing. Please provide feedback for improvements.</li>
    </ol>
  </div>

  <div class="chat-container">
    <div id="chat-box" class="chat-box"></div>
    <div class="chat-input">
      <input id="user-input" type="text" placeholder="Type your message..." />
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <script>
    // =========================
    // MODULE 1: State Variables
    // =========================
    const chatBox = document.getElementById("chat-box");
    const userInput = document.getElementById("user-input");

    let currentStep = null;
    let currentScenario = null;

    // =========================
    // MODULE 2: Proof Database
    // =========================
    // Define required proofs for each medical scenario
    const medicalProofs = {
      emergency: ["medical record or diagnosis report", "sick-leave certificate", "proof of medical charge"],
      "not suitable for travel": ["medical record or diagnosis report", "sick-leave certificate", "proof of medical charge"],
      "be hospitalized": ["medical record or diagnosis report", "hospitalization certificate", "proof of medical charge"],
      fracture: ["medical record or diagnosis report", "sick-leave certificate", "proof of medical charge"],
      pregnancy: ["medical record or diagnosis report", "sick-leave certificate", "proof of medical charge"],
      "mental health": null,
      death: null
    };

    // =========================
    // MODULE 3: Helper Functions
    // =========================
    // Add a new message bubble
    function addMessage(text, sender = "bot") {
      const bubble = document.createElement("div");
      bubble.className = `bubble ${sender}`;
      bubble.innerText = text;
      chatBox.appendChild(bubble);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Send user input
    function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;
      addMessage(text, "user");
      userInput.value = "";
      handleInput(text.toLowerCase());
    }
    userInput.addEventListener("keypress", function (e) {
      if (e.key === "Enter") sendMessage();
    });

    // =========================
    // MODULE 4: Automation Features
    // =========================

    // 🔹 Fuzzy proof checker (improvement)
    function checkProofs(provided, required) {
      // Normalize input: split by comma and lowercase
      const providedProofs = provided.split(",").map(p => p.trim().toLowerCase());
      // Check missing proofs
      const missing = required.filter(req =>
        !providedProofs.some(prov => prov.includes(req.toLowerCase()))
      );
      return missing;
    }

    // 🔹 Complaint Ticket Pre-fill
    function generateComplaintTicket(reason) {
      return `📄 Complaint Ticket Template\n\n` +
             `Category: Difficulties with Cancellation\n` +
             `Subtype: Service Guarantee\n` +
             `Reason: ${reason}\n` +
             `Required Proof: Hotel charge receipt\n` +
             `Remarks: Merchant refused refund despite F-H Guarantee eligibility.`;
    }

    // =========================
    // MODULE 5: Core Conversation Logic
    // =========================
    function handleInput(input) {
      if (input === "cancel") {
        addMessage("Please select an option:\n1️⃣ Flight-Hotel Guarantee\n2️⃣ Special Circumstances\n3️⃣ Merchant Refusal");
        currentStep = "mainMenu";
        return;
      }

      if (currentStep === "mainMenu") {
        if (input === "1") {
          addMessage("Please enter your flight date and hotel check-in date in this format:\nYYYY-MM-DD to YYYY-MM-DD");
          currentStep = "flightDates";
        } else if (input === "2") {
          addMessage("Select reason:\n1️⃣ Hotel rejected\n2️⃣ Insufficient Proof\n3️⃣ Special Circumstances");
          currentStep = "specialMenu";
        } else if (input === "3") {
          // NEW FEATURE: Complaint pre-fill
          addMessage(generateComplaintTicket("Merchant Refusal"));
          currentStep = null;
        } else {
          addMessage("❓ Not recognized. Please type 'cancel' to restart.");
        }
        return;
      }

      // ========== Flight-Hotel Guarantee Flow ==========
      if (currentStep === "flightDates") {
        const datePattern = /^(\d{4}-\d{2}-\d{2})\s+to\s+(\d{4}-\d{2}-\d{2})$/;
        const match = input.match(datePattern);

        if (match) {
          const flightDate = new Date(match[1]);
          const hotelDate = new Date(match[2]);

          if (flightDate > hotelDate) {
            addMessage("⚠️ Flight arrival is after hotel check-in. Possible F-H Guarantee case.");
            addMessage("✈️ Was this due to an involuntary airline change (cancellation or delay)? (yes/no)");
            currentStep = "involuntaryChange";
          } else {
            addMessage("✔ Flight date does not conflict with hotel check-in. Not covered by F-H Guarantee.");
            currentStep = null;
          }
        } else {
          addMessage("⚠️ Please enter dates in format: YYYY-MM-DD to YYYY-MM-DD");
        }
        return;
      }

      if (currentStep === "involuntaryChange") {
        if (input === "yes") {
          addMessage("👤 Is the affected passenger also the hotel guest? (yes/no)");
          currentStep = "passengerMatch";
        } else {
          addMessage("❌ Not covered: Guarantee only applies for involuntary airline changes.");
          currentStep = null;
        }
        return;
      }

      if (currentStep === "passengerMatch") {
        if (input === "yes") {
          addMessage("✔ All conditions met. Proceed with Flight-Hotel Guarantee flow.");
        } else {
          addMessage("❌ Not covered: Passenger must match hotel guest.");
        }
        currentStep = null;
        return;
      }

      // ========== Special Circumstances Flow ==========
      if (currentStep === "specialMenu") {
        if (input === "1") {
          addMessage("📌 Please send the script provided by KA/QC for Hotel Rejected cases.");
          currentStep = null;
        } else if (input === "2" || input === "3") {
          addMessage("Please specify the circumstance (emergency, not suitable for travel, be hospitalized, fracture, pregnancy, mental health, death).");
          currentStep = "askScenario";
        } else {
          addMessage("❓ Not recognized. Please type 'cancel' to restart.");
        }
        return;
      }

      if (currentStep === "askScenario") {
        if (medicalProofs[input] === null && input === "mental health") {
          addMessage("⚠️ For Mental Health cases, please escalate the case directly.");
          currentStep = null;
        } else if (medicalProofs[input] === null && input === "death") {
          addMessage("⚰ No proof needed. Please remark 'canceled due to death' and indicate relationship.");
          currentStep = null;
        } else if (medicalProofs[input]) {
          currentScenario = input;
          addMessage(`What proof was provided for ${input}? (list with commas)`);
          currentStep = "askProof";
        } else {
          addMessage("❓ Not recognized. Please check Service Guarantee links:\nFlight-Hotel: [link]\nSpecial Circumstances: [link]");
          currentStep = null;
        }
        return;
      }

      if (currentStep === "askProof") {
        if (currentScenario) {
          const requiredProofs = medicalProofs[currentScenario];
          const missingProofs = checkProofs(input, requiredProofs); // 🔹 uses new helper

          if (missingProofs.length > 0) {
            addMessage(`📌 Missing proofs: ${missingProofs.join(", ")}\nPlease ask the guest for the insufficient proofs and use the KA script.`);
          } else {
            addMessage("✔ All required proofs provided. Proceed with service guarantee flow.");
          }
        }
        currentStep = null;
        currentScenario = null;
        return;
      }

      // ========== Fallback ==========
      addMessage("🤔 I’m not sure about that. Please check Service Guarantee links:\nFlight-Hotel: [link]\nSpecial Circumstances: [link]");
    }

    // =========================
    // MODULE 6: Startup Greeting
    // =========================
    addMessage("👋 Welcome! Type 'cancel' to begin a Service Guarantee workflow.");
  </script>
</body>
</html>