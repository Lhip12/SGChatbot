<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Service Guarantee Chatbot</title>
<style>
  body {
    font-family: Dengxian, Arial, sans-serif;
    margin: 0;
    display: flex;
    height: 100vh;
    background: #f5f7fa;
  }

  .instructions {
    flex: 1;
    padding: 20px;
    background: #fff;
    overflow-y: auto;
    border-left: 2px solid #ccc; /* Instructions on right */
  }

  .instructions h2 {
    margin-top: 0;
  }

  .bot-capabilities {
    background: #e0f0ff;
    border: 1px solid #99ccff;
    padding: 10px;
    margin-bottom: 15px;
  }

  .kh-links {
    background: #fff3cd;
    border-left: 4px solid #ffeeba;
    padding: 10px;
    margin-bottom: 15px;
    font-size: 0.9em;
  }

  .chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    background: #e9eff5;
    padding: 10px;
    border-right: 2px solid #ccc;
  }

  .chat-box {
    flex: 1;
    padding: 10px;
    overflow-y: auto;
  }

  .chat-input {
    display: flex;
    padding: 10px;
    background: #fff;
    border-top: 1px solid #ccc;
  }

  .chat-input input {
    flex: 1;
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-family: Dengxian, Arial, sans-serif;
  }

  .bubble {
    max-width: 70%;
    padding: 10px;
    margin: 10px 0;
    border-radius: 15px;
    line-height: 1.6;
    word-break: break-word;
    font-family: Dengxian, Arial, sans-serif;
    white-space: pre-wrap;
  }

  .bot {
    background: #007bff;
    color: white;
    align-self: flex-start;
  }

  .user {
    background: #ddd;
    align-self: flex-end;
  }

  .button-bubble {
    display: inline-block;
    margin: 5px 5px 0 0;
    padding: 8px 12px;
    background: #00aaff;
    color: white;
    border-radius: 12px;
    cursor: pointer;
    font-family: Dengxian, Arial, sans-serif;
  }

  .script-block {
    background: #fff3cd;
    border-left: 4px solid #ffeeba;
    padding: 10px;
    margin: 10px 0;
    white-space: pre-wrap;
  }

  .loading {
    width: 20px;
    height: 20px;
    border: 3px solid #f3f3f3;
    border-top: 3px solid #007bff;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 10px 0;
  }

  @keyframes spin {
    0% { transform: rotate(0deg);}
    100% { transform: rotate(360deg);}
  }

  .form-input {
    display: flex;
    flex-direction: column;
    margin: 10px 0;
  }

  .form-input label {
    margin: 5px 0 2px 0;
  }

  .form-input input {
    padding: 5px;
    font-family: Dengxian, Arial, sans-serif;
  }

</style>
</head>
<body>

<div class="chat-container">
  <div id="chat-box" class="chat-box"></div>
  <div class="chat-input">
    <input id="user-input" type="text" placeholder="Type your message..." />
    <button onclick="sendMessage()">Send</button>
  </div>
</div>

<div class="instructions">
  <h2>Service Guarantee Instructions</h2>

  <div class="bot-capabilities">
    <strong>Bot Capabilities:</strong>
    <ul>
      <li>Judge Flight-Hotel Guarantee eligibility</li>
      <li>Guide Special Circumstance cancellation workflow</li>
      <li>Remind agents about missing proofs</li>
      <li>Provide QA-approved script templates</li>
      <li>Provide Knowledge Hub links</li>
    </ul>
  </div>

  <div class="kh-links">
    <strong>Special Circumstance KH Links:</strong>
    <ul>
      <li>Not suitable for travel: Medical Record / Sick-leave Certificate / Proof of Medical Charge</li>
      <li>Be hospitalized: Medical Record / Hospitalization Certificate / Proof of Medical Charge</li>
      <li>Fracture: Medical Record / Sick-leave Certificate / Proof of Medical Charge</li>
      <li>Pregnancy: Medical Record / Sick-leave Certificate / Proof of Medical Charge</li>
      <li>Mental health: Escalate to CS</li>
      <li>Death: No proof needed (remark "canceled due to death" and indicate relationship)</li>
    </ul>
    <br>
    <strong>Accepted proofs (for input):</strong>
    <ul>
      <li>official diagnostics</li>
      <li>medical leave certificate</li>
      <li>proof of medical charge</li>
      <li>proof of relationship</li>
    </ul>
  </div>
</div>

<script>
const chatBox = document.getElementById("chat-box");
const userInput = document.getElementById("user-input");

let currentStep = null;
let currentScenario = null;
let providedProofs = [];
let specialType = null;

// Flight-Hotel Guarantee eligibility
function isFhEligible(flightArrival, hotelCheckIn){
  return flightArrival <= hotelCheckIn;
}

// Scripts (Special Circumstance)
const scripts = {
  1: `Greetings from Trip.com! ...`, // Keep QA-approved script content
  2: `Dear [Guest's Name], ...`,
  3: `I am very sorry to inform you that ...`,
  4: `Dear [Guest's Name], ...`
};

function addMessage(text,sender="bot",loading=false){
  if(loading){
    const load = document.createElement("div");
    load.className="loading";
    chatBox.appendChild(load);
    chatBox.scrollTop = chatBox.scrollHeight;
    setTimeout(()=>{
      chatBox.removeChild(load);
      addMessage(text,sender);
    },500);
    return;
  }
  const bubble = document.createElement("div");
  bubble.className=`bubble ${sender}`;
  bubble.textContent=text;
  chatBox.appendChild(bubble);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function showButtons(options,callback){
  const bubble = document.createElement("div");
  bubble.className="bubble bot";
  options.forEach((opt,i)=>{
    const btn = document.createElement("div");
    btn.className="button-bubble";
    btn.textContent=opt;
    btn.onclick = ()=>{addMessage(opt,"user"); callback(i+1);}
    bubble.appendChild(btn);
  });
  chatBox.appendChild(bubble);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function handleOption(opt){
  if(currentStep==="selectScenario"){
    currentScenario=opt;
    if(opt===1){
      currentStep="fhDates";
      addMessage("Flight-Hotel Guarantee selected. Please fill out the dates:");
      addFhForm();
    } else if(opt===2){
      currentStep="specialType";
      addMessage("Select Special Circumstance type:", "bot", true);
      showButtons(["Not suitable for travel","Be hospitalized","Fracture","Pregnancy","Mental health","Death"],handleSpecialType);
    }
  } else if(currentStep==="scriptSelection"){
    insertScript(opt);
  }
}

function handleSpecialType(opt){
  const types=["Not suitable for travel","Be hospitalized","Fracture","Pregnancy","Mental health","Death"];
  specialType = types[opt-1];
  addMessage(`Special Circumstance selected: ${specialType}`);
  currentStep="specialProofs";
  addMessage("Enter proofs currently provided (comma separated):");
}

function insertScript(num){
  if(scripts[num]){
    const block = document.createElement("div");
    block.className="script-block";
    block.textContent=`Script selected â†’\n\n${scripts[num]}`;
    chatBox.appendChild(block);
    chatBox.scrollTop = chatBox.scrollHeight;
  }
}

function addFhForm(){
  const formDiv = document.createElement("div");
  formDiv.className="form-input";
  formDiv.innerHTML=`
    <label>Affected flight dates:</label>
    <input id="fh-flight" type="date" />
    <label>Hotel check-in date:</label>
    <input id="fh-checkin" type="date" />
    <button id="fh-submit">Submit</button>
  `;
  chatBox.appendChild(formDiv);
  chatBox.scrollTop = chatBox.scrollHeight;
  document.getElementById("fh-submit").onclick=()=>{
    const flightDate = new Date(document.getElementById("fh-flight").value);
    const hotelDate = new Date(document.getElementById("fh-checkin").value);
    const eligible = isFhEligible(flightDate,hotelDate);
    addMessage(eligible ? "Flight-Hotel Guarantee eligible based on dates" : "Flight-Hotel Guarantee not applicable (hotel check-in not affected)");
    currentStep="completed";
  };
}

function processMessage(msg){
  if(msg.toLowerCase()==="cancel"){
    currentStep="selectScenario";
    addMessage("ðŸ‘‹ Welcome! Type 'Cancel' to begin a Service Guarantee workflow.", "bot", true);
    showButtons(["Flight-Hotel Guarantee","Special Circumstance"],handleOption);
    return;
  }

  if(currentStep==="specialProofs"){
    providedProofs = msg.split(",").map(s=>s.trim().toLowerCase());
    const allProofs = ["official diagnostics","medical leave certificate","proof of medical charge","proof of relationship"];
    const missing = allProofs.filter(p=>!providedProofs.includes(p));
    addMessage(missing.length>0 ? `Missing proofs: ${missing.join(", ")}` : "All necessary proofs provided.");
    currentStep="scriptSelection";
    addMessage("Select which script to send:", "bot", true);
    showButtons(["Script 1","Script 2","Script 3","Script 4"], handleOption);
  }
}

// Enter key
userInput.addEventListener("keydown",function(e){
  if(e.key==="Enter") sendMessage();
});

function sendMessage(){
  const text = userInput.value.trim();
  if(!text) return;
  addMessage(text,"user");
  userInput.value="";
  processMessage(text);
}

// Start
addMessage("ðŸ‘‹ Welcome! Type 'Cancel' to begin a Service Guarantee workflow.", "bot");
currentStep="selectScenario";
showButtons(["Flight-Hotel Guarantee","Special Circumstance"],handleOption);

</script>
</body>
</html>